#!/bin/sh

readonly YAZFI_NAME="YazFi"
readonly YAZFI_VERSION="v3.0.0"
readonly YAZFI_BRANCH="develop"
readonly YAZFI_REPO="https://raw.githubusercontent.com/jackyaz/YazFi/""$YAZFI_BRANCH""/YazFi"

Check_Lock(){
	if [ -f "/tmp/$YAZFI_NAME.lock" ]; then
		ageoflock=$(($(date +%s) - $(date +%s -r /tmp/$YAZFI_NAME.lock)))
		if [ "$ageoflock" -gt 120 ]; then
			Print_Output "true" "Stale lock file found (>120 seconds old) - purging lock" "$ERR"
			kill "$(sed -n '1p' /tmp/$YAZFI_NAME.lock)" >/dev/null 2>&1
			Clear_Lock
			echo "$$" > "/tmp/$YAZFI_NAME.lock"
			return 0
		else
			Print_Output "true" "Lock file found (age: $ageoflock seconds) - stopping to prevent duplicate runs" "$ERR"
			exit 1
		fi
	else
		echo "$$" > "/tmp/$YAZFI_NAME.lock"
		return 0
	fi
}

Clear_Lock(){
	rm -f "/tmp/$YAZFI_NAME.lock" 2>/dev/null
	return 0
}

Check_Lock
/usr/sbin/curl -fsL --retry 3 "$YAZFI_REPO.sh" -o "/jffs/scripts/$YAZFI_NAME"
chmod 0755 "/jffs/scripts/$YAZFI_NAME"
Clear_Lock
/jffs/scripts/$YAZFI_NAME runnow &
exit 0
